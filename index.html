<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>下雪特效</title>
    <style>
        * { margin: 0; padding: 0; }
        body { overflow: hidden; background: transparent; }
        #snow-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 2147483647;
        }
    </style>
</head>
<body>
    <canvas id="snow-canvas"></canvas>

    <script>
        const canvas = document.getElementById('snow-canvas');
        const ctx = canvas.getContext('2d');

        let width, height;
        let settings = { size: 3, quantity: 100, speed: 2, accumulation: 500, accumulationSpeed: 0.2 };

        // 雪花数组 - 使用简单对象而非类
        let flakes = [];
        // 积雪高度数组 - 间距增大到5px
        let snowHeight = [];
        const SPACING = 5;
        // 落地粒子效果
        let particles = [];

        // 鼠标
        let mouse = { x: -1000, y: -1000, vx: 0, vy: 0 };
        let windX = 0;
        let windY = 0;

        function resize() {
            width = window.innerWidth;
            height = window.innerHeight;
            canvas.width = width;
            canvas.height = height;
            snowHeight = new Array(Math.ceil(width / SPACING) + 1).fill(0);
        }

        function createFlake(fromTop) {
            return {
                x: Math.random() * width,
                y: fromTop ? -10 : Math.random() * height,
                r: settings.size * 0.5 + Math.random() * 2,
                vx: (Math.random() - 0.5) * 0.3,
                vy: 0.3 + Math.random() * 0.5,
                windX: 0,
                windY: 0,
                swing: Math.random() * Math.PI * 2,
                swingSpeed: 0.02 + Math.random() * 0.02,
                swingAmp: 0.5 + Math.random() * 1
            };
        }

        function initFlakes() {
            const count = Math.min(settings.quantity, 300);
            flakes = [];
            for (let i = 0; i < count; i++) {
                flakes.push(createFlake(false));
            }
        }

        function update() {
            windX *= 0.95;
            windY *= 0.95;

            // 更新粒子
            for (let i = particles.length - 1; i >= 0; i--) {
                const p = particles[i];
                p.x += p.vx;
                p.y += p.vy;
                p.vy += 0.02;
                p.life -= 0.05;
                if (p.life <= 0) particles.splice(i, 1);
            }
            // 限制粒子数量
            if (particles.length > 50) particles.splice(0, particles.length - 50);

            for (let i = 0; i < flakes.length; i++) {
                const f = flakes[i];

                // 鼠标风力
                const dx = f.x - mouse.x;
                const dy = f.y - mouse.y;
                const dist = dx * dx + dy * dy;
                if (dist < 40000) {
                    f.windX += (windX * (1 - dist / 40000) - f.windX) * 0.1;
                    f.windY += (windY * (1 - dist / 40000) - f.windY) * 0.1;
                } else {
                    f.windX *= 0.9;
                    f.windY *= 0.9;
                }

                f.x += f.vx + f.windX;
                f.y += f.vy * settings.speed + f.windY;

                if (f.x < 0) f.x = width;
                if (f.x > width) f.x = 0;

                // 检查落地
                const idx = Math.floor(f.x / SPACING);
                const groundY = height - (snowHeight[idx] || 0);

                if (f.y >= groundY - f.r) {
                    // 创建落地粒子效果 - 雪花轻柔散开
                    for (let p = 0; p < 2; p++) {
                        particles.push({
                            x: f.x + (Math.random() - 0.5) * 10,
                            y: groundY - Math.random() * 5,
                            vx: (Math.random() - 0.5) * 0.5,
                            vy: Math.random() * 0.3,
                            r: f.r * 0.4,
                            life: 1
                        });
                    }
                    // 增加积雪 - 分散到周围点使其更平滑
                    const range = 3;
                    for (let j = -range; j <= range; j++) {
                        const ni = idx + j;
                        if (ni >= 0 && ni < snowHeight.length) {
                            const factor = 1 - Math.abs(j) / (range + 1);
                            // snowHeight[ni] = Math.min(snowHeight[ni] + f.r * 0.15 * factor, height * 0.4);
                            snowHeight[ni] = Math.min(snowHeight[ni] + f.r * settings.accumulationSpeed * factor, height * 0.4);
                        }
                    }
                    // 重置雪花
                    f.r = settings.size * 0.5 + Math.random() * 2;
                    f.x = Math.random() * width;
                    f.y = -10;
                    f.windX = 0;
                    f.windY = 0;
                }
            }
        }

        function draw() {
            ctx.clearRect(0, 0, width, height);

            // 绘制雪花
            ctx.fillStyle = 'rgba(255,255,255,0.9)';
            ctx.beginPath();
            for (let i = 0; i < flakes.length; i++) {
                const f = flakes[i];
                ctx.moveTo(f.x + f.r, f.y);
                ctx.arc(f.x, f.y, f.r, 0, Math.PI * 2);
            }
            ctx.fill();

            // 绘制落地粒子
            for (let i = 0; i < particles.length; i++) {
                const p = particles[i];
                ctx.globalAlpha = p.life;
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.r, 0, Math.PI * 2);
                ctx.fill();
            }
            ctx.globalAlpha = 1;

            // 绘制积雪 - 使用平滑曲线
            ctx.fillStyle = 'rgba(255,255,255,0.9)';
            ctx.beginPath();
            ctx.moveTo(0, height);
            ctx.lineTo(0, height - snowHeight[0]);
            for (let i = 1; i < snowHeight.length - 1; i++) {
                const x0 = (i - 1) * SPACING;
                const x1 = i * SPACING;
                const x2 = (i + 1) * SPACING;
                const y0 = height - snowHeight[i - 1];
                const y1 = height - snowHeight[i];
                const y2 = height - snowHeight[i + 1];
                const cpx = x1;
                const cpy = y1;
                const endx = (x1 + x2) / 2;
                const endy = (y1 + y2) / 2;
                ctx.quadraticCurveTo(cpx, cpy, endx, endy);
            }
            ctx.lineTo(width, height - snowHeight[snowHeight.length - 1]);
            ctx.lineTo(width, height);
            ctx.closePath();
            ctx.fill();
        }

        function animate() {
            update();
            draw();
            requestAnimationFrame(animate);
        }

        window.addEventListener('resize', resize);

        window.electron.onMouseMove((point) => {
            const vx = point.x - mouse.x;
            const vy = point.y - mouse.y;
            mouse.x = point.x;
            mouse.y = point.y;
            windX += (vx * 0.2 - windX) * 0.1;
            windY += (vy * 0.2 - windY) * 0.1;

            // 只有鼠标靠近积雪时才清除
            const idx = Math.floor(mouse.x / SPACING);
            const snowY = height - (snowHeight[idx] || 0);
            if (mouse.y > snowY - 30) {
                for (let i = Math.max(0, idx - 10); i < Math.min(snowHeight.length, idx + 10); i++) {
                    const d = Math.abs(i - idx);
                    if (snowHeight[i] > 0) {
                        snowHeight[i] = Math.max(0, snowHeight[i] - (10 - d) * 0.5);
                    }
                }
            }
        });

        window.electron.onSettingsUpdated((s) => {
            settings = { ...settings, ...s };
            initFlakes();
        });

        resize();
        initFlakes();
        animate();
    </script>
</body>
</html>
